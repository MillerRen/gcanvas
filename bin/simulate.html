<style>
body {
  background: #ccc;
  font-family: "helvetica neue";
  margin: 0px;
}

canvas {
  padding: 20px;
  margin: 20px;
  background: white;
  display: block;
  border: 1px solid #bbb;
  border-radius: 5px;
}

h1 {
  margin: 20px;
  font-weight: 300;
}

h2 {
  margin: 20px;
  font-weight: 300;
}
.example {
  /* border-bottom: 1px solid gray; */
  position: relative;
  height: 300px;
}

.real {
  background: white;
  position: absolute;
  left: 20px;
  border: 1px solid #ddd;
}

.sim {
  background: white;
  position: absolute;
  width: 100%;
  height: 100%;
}

</style>

<script src="../build/gcanvas.js"></script>

<script>
var setupQueue = [];
var domLoaded = false;

function setup(desc, fn) {
  setupQueue.push(fn);

  if(domLoaded) {
    procQueue();
  }
}

function procQueue() {
  var fn;
  while(fn = setupQueue.pop()) {
    var realcanvas = document.createElement('canvas');
    realcanvas.width = 2000;
    realcanvas.height = 1000;
    document.body.appendChild(realcanvas);

    var ctx = realcanvas.getContext('2d');

    ctx.translate(1000.5,500.5);
    ctx.scale(2,2);
    ctx.lineWidth = 0.5;

    ctx.strokeStyle = 'rgba(0,0,0,.1)'
    ctx.moveTo(0,-250);
    ctx.lineTo(0,250);
    ctx.moveTo(-400,0);
    ctx.lineTo(400,0);
    ctx.stroke();

    ctx.save();
    ctx.strokeStyle = 'rgba(0,0,0,.5)'
    ctx.translate(0,-250);
    ruler(ctx,30,500,-500);
    ctx.restore();

    ctx.save();
    ctx.strokeStyle = 'rgba(0,0,0,.5)'
    ctx.translate(-500,0);
    ctx.rotate(-Math.PI/2);
    ruler(ctx,30,500,-500);
    ctx.restore();






    var simdriver = new GCanvas.Simulator(ctx);
    var simctx = new GCanvas(simdriver, 200, 200);
    var simcanvas = simctx.canvas;

    fn(simctx);
  }
}

function injectScript(uri, callback) {
  // Actual script
  var script = document.createElement('script');
  script.src = uri;
  document.body.appendChild(script);

  // The callback datauri script
  var uuid = 'callback' + Math.round(Math.random()*0xffffffff);
  var src = 'data:application/javascript;charset=utf-8,' + 
    encodeURIComponent(uuid+'();');
  window[uuid] = callback;
  var script = document.createElement('script');
  script.src = src;
  setTimeout(function() {
    document.body.appendChild(script);
  });
}

function ruler(ctx, width, length, start) {
  ctx.font="7px helvetica";

  start = start || 1;

  ctx.beginPath();

  // metric
  ctx.beginPath();
  for(var x = start; x <= length; ++x) {

    ctx.beginPath();

    // market line
    var ml = x % 10 ? 1 : 1000;

    ctx.save();
    ctx.strokeStyle = 'rgba(0,0,0,0.2)';
    ctx.moveTo(x, 0);
    ctx.lineTo(x, ml);
    ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.translate(x-5, 5);
    ctx.rotate(Math.PI/2);

    if(x && x % 10 === 0) {
      ctx.fillText(x+'', 0, -2);
      // ctx.strokeText(''+(x*25.4).toFixed(1), 2, -0.1);
    }
    ctx.restore();
  }

  // inches
  // for(var i = Math.floor(start*8/25.4), x=0; x < length; i++) {

  //   x = i*25.4/8;

  //   ctx.beginPath();

  //   // market line
  //   var ml = i % 8 ? (i % 4 ? (i % 2 ? 1 : 2) : 3) : 4;
  //   // ml = (ml/2)*ml;

  //   ctx.moveTo(x, width-ml);
  //   ctx.lineTo(x, width);

  //   // if(ml == 1)  {
  //   //   // bubble to align marker with text
  //   //   ctx.arc(x, ml+0.5, 0.5, -Math.PI/2, 0);
  //   //   ctx.arc(x, 10-ml, 0.5, 0, Math.PI/2);
  //   //   ctx.arc(x, 10-ml, 0.5, Math.PI/2, Math.PI);
  //   //   ctx.arc(x, ml+0.5, 0.5, Math.PI, Math.PI*1.5);
  //   // }

  //   // ctx.moveTo(x, 11);
  //   // ctx.lineTo(x, 10.5-ml);

  //   ctx.stroke();

  //   ctx.save();
  //   ctx.translate(x-1, width-ml-5);
  //   ctx.rotate(Math.PI/2);
  //   if(i && i % 8 === 0) {
  //     ctx.fillText(i/8, 0, 0);
  //   }
  //   ctx.restore();
  // }
}

document.addEventListener('DOMContentLoaded', function() {
  procQueue();
  domLoaded = true;

  if(window.location.search) {
    injectScript(window.location.search.slice(1), function() {
      if(window.main) {
        setup('main', window.main);
      }
    });
  }
});

</script>

